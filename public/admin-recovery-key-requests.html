<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Admin - Recovery Key Reset Requests</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
                    sans-serif;
                background-color: #f9fafb;
                color: #111827;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            .header {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                margin-bottom: 20px;
            }

            .header h1 {
                color: #1f2937;
                margin-bottom: 10px;
            }

            .header p {
                color: #6b7280;
            }

            /* Notification Panel Styles */
            .notification-panel {
                background: white;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                margin-bottom: 20px;
                overflow: hidden;
            }

            .notification-header {
                background: #3b82f6;
                color: white;
                padding: 15px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .notification-header h3 {
                margin: 0;
                font-size: 16px;
                font-weight: 600;
            }

            .notification-badge {
                background: #ef4444;
                color: white;
                border-radius: 50%;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: bold;
            }

            .notification-list {
                max-height: 300px;
                overflow-y: auto;
            }

            .notification-item {
                padding: 15px 20px;
                border-bottom: 1px solid #e5e7eb;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: background-color 0.2s;
            }

            .notification-item:hover {
                background-color: #f9fafb;
            }

            .notification-item:last-child {
                border-bottom: none;
            }

            .notification-content {
                flex: 1;
            }

            .notification-title {
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 4px;
            }

            .notification-message {
                color: #6b7280;
                font-size: 14px;
                margin-bottom: 4px;
            }

            .notification-time {
                color: #9ca3af;
                font-size: 12px;
            }

            .notification-actions {
                display: flex;
                gap: 8px;
            }

            .notification-btn {
                padding: 6px 12px;
                border: none;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .notification-btn.primary {
                background: #3b82f6;
                color: white;
            }

            .notification-btn.primary:hover {
                background: #2563eb;
            }

            .notification-btn.secondary {
                background: #e5e7eb;
                color: #374151;
            }

            .notification-btn.secondary:hover {
                background: #d1d5db;
            }

            .no-notifications {
                padding: 40px 20px;
                text-align: center;
                color: #6b7280;
            }

            .refresh-btn {
                background: #10b981;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.2s;
            }

            .refresh-btn:hover {
                background: #059669;
            }

            .refresh-btn:disabled {
                background: #9ca3af;
                cursor: not-allowed;
            }

            .requests-container {
                background: white;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            .request-item {
                padding: 20px;
                border-bottom: 1px solid #e5e7eb;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .request-item:last-child {
                border-bottom: none;
            }

            .request-info {
                flex: 1;
            }

            .request-info h3 {
                color: #1f2937;
                margin-bottom: 5px;
            }

            .request-info p {
                color: #6b7280;
                margin-bottom: 3px;
                font-size: 14px;
            }

            .request-actions {
                display: flex;
                gap: 10px;
            }

            .btn {
                padding: 8px 16px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s;
            }

            .btn-approve {
                background-color: #10b981;
                color: white;
            }

            .btn-approve:hover {
                background-color: #059669;
            }

            .btn-reject {
                background-color: #ef4444;
                color: white;
            }

            .btn-reject:hover {
                background-color: #dc2626;
            }

            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .no-requests {
                padding: 40px;
                text-align: center;
                color: #6b7280;
            }

            .loading {
                padding: 40px;
                text-align: center;
                color: #6b7280;
            }

            .error {
                padding: 20px;
                background-color: #fef2f2;
                border: 1px solid #fecaca;
                border-radius: 6px;
                color: #dc2626;
                margin-bottom: 20px;
            }

            .success {
                padding: 20px;
                background-color: #f0fdf4;
                border: 1px solid #bbf7d0;
                border-radius: 6px;
                color: #16a34a;
                margin-bottom: 20px;
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            }

            .modal-content {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 8px;
                max-width: 500px;
                width: 90%;
            }

            .modal h3 {
                margin-bottom: 15px;
                color: #1f2937;
            }

            .modal textarea {
                width: 100%;
                height: 100px;
                padding: 10px;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                margin-bottom: 20px;
                resize: vertical;
            }

            .modal-actions {
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }

            .btn-secondary {
                background-color: #6b7280;
                color: white;
            }

            .btn-secondary:hover {
                background-color: #4b5563;
            }

            .temp-key-display {
                background-color: #f0f9ff;
                border: 1px solid #0ea5e9;
                border-radius: 6px;
                padding: 15px;
                margin: 10px 0;
                position: relative;
            }

            .temp-key-display h4 {
                color: #0c4a6e;
                margin-bottom: 10px;
                font-size: 14px;
            }

            .temp-key-container {
                display: flex;
                align-items: center;
                gap: 10px;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 4px;
                padding: 8px 12px;
            }

            .temp-key-text {
                font-family: 'Courier New', monospace;
                font-size: 14px;
                color: #1f2937;
                flex: 1;
                word-break: break-all;
                background: none;
                border: none;
                outline: none;
            }

            .copy-btn {
                background-color: #3b82f6;
                color: white;
                border: none;
                border-radius: 4px;
                padding: 6px 12px;
                font-size: 12px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .copy-btn:hover {
                background-color: #2563eb;
            }

            .copy-btn.copied {
                background-color: #10b981;
            }

            .close-temp-key {
                position: absolute;
                top: 10px;
                right: 10px;
                background: none;
                border: none;
                font-size: 18px;
                cursor: pointer;
                color: #6b7280;
            }

            .close-temp-key:hover {
                color: #374151;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Recovery Key Reset Requests</h1>
                <p>Review and manage user requests for recovery key resets</p>
                <div style="text-align: right; margin-top: 10px">
                    <a
                        href="/admin"
                        style="
                            color: #6b7280;
                            text-decoration: none;
                            font-size: 14px;
                        "
                        >← Back to Admin Panel</a
                    >
                    <button
                        id="testButton"
                        style="
                            margin-left: 10px;
                            padding: 5px 10px;
                            background: #3b82f6;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        "
                    >
                        Test JS
                    </button>
                </div>
            </div>

            <!-- Notification Panel -->
            <div class="notification-panel">
                <div class="notification-header">
                    <h3>🔔 Recent Requests</h3>
                    <div style="display: flex; align-items: center; gap: 10px">
                        <span class="notification-badge" id="notificationBadge"
                            >0</span
                        >
                        <button
                            class="refresh-btn"
                            id="refreshNotifications"
                            onclick="loadNotifications()"
                        >
                            🔄 Refresh
                        </button>
                    </div>
                </div>
                <div class="notification-list" id="notificationList">
                    <div class="no-notifications">
                        <p>No recent requests</p>
                    </div>
                </div>
            </div>

            <div id="message"></div>

            <div id="tempKeyDisplay" style="display: none"></div>

            <div class="requests-container" id="requestsContainer">
                <div class="loading">Loading requests...</div>
            </div>
        </div>

        <!-- Reject Modal -->
        <div id="rejectModal" class="modal">
            <div class="modal-content">
                <h3>Reject Request</h3>
                <p>Please provide a reason for rejecting this request:</p>
                <textarea
                    id="rejectReason"
                    placeholder="Enter rejection reason..."
                ></textarea>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancelRejectBtn">
                        Cancel
                    </button>
                    <button class="btn btn-reject" id="confirmRejectBtn">
                        Reject Request
                    </button>
                </div>
            </div>
        </div>

        <script>
            let currentUserId = null;
            let authToken = localStorage.getItem('adminToken');

            // Check if user is authenticated
            function checkAuth() {
                if (!authToken) {
                    // Try to get token from session storage or prompt for login
                    const sessionToken = sessionStorage.getItem('adminToken');
                    if (sessionToken) {
                        authToken = sessionToken;
                        localStorage.setItem('adminToken', sessionToken);
                    } else {
                        // Redirect to admin login page
                        window.location.href = '/admin-login.html';
                        return false;
                    }
                }
                return true;
            }

            // Load requests on page load
            document.addEventListener('DOMContentLoaded', () => {
                console.log('Page loaded, checking auth...');
                const isAuthenticated = checkAuth();
                console.log('Auth check result:', isAuthenticated);
                console.log('Current authToken:', authToken);
                if (isAuthenticated) {
                    loadRequests();
                    loadNotifications();
                }

                // Add event listener for test button
                const testButton = document.getElementById('testButton');
                if (testButton) {
                    testButton.addEventListener('click', () => {
                        console.log('Test button clicked');
                        alert('JavaScript is working!');
                    });
                }

                // Add event listeners for reject modal buttons
                const cancelRejectBtn =
                    document.getElementById('cancelRejectBtn');
                const confirmRejectBtn =
                    document.getElementById('confirmRejectBtn');

                if (cancelRejectBtn) {
                    cancelRejectBtn.addEventListener('click', closeRejectModal);
                }

                if (confirmRejectBtn) {
                    confirmRejectBtn.addEventListener('click', confirmReject);
                }
            });

            async function loadRequests() {
                try {
                    const response = await fetch(
                        `${window.location.origin}/api/auth/recovery-key-reset-requests`,
                        {
                            method: 'GET',
                            headers: {
                                Authorization: `Bearer ${authToken}`,
                                'Content-Type': 'application/json',
                            },
                        }
                    );

                    if (!response.ok) {
                        throw new Error('Failed to load requests');
                    }

                    const data = await response.json();
                    displayRequests(data.requests);
                } catch (error) {
                    showMessage(
                        'Error loading requests: ' + error.message,
                        'error'
                    );
                }
            }

            function displayRequests(requests) {
                const container = document.getElementById('requestsContainer');

                if (requests.length === 0) {
                    container.innerHTML =
                        '<div class="no-requests">No pending recovery key reset requests</div>';
                    return;
                }

                container.innerHTML = requests
                    .map(
                        (request) => `
                <div class="request-item">
                    <div class="request-info">
                        <h3>${request.name}</h3>
                        <p><strong>Email:</strong> ${request.email}</p>
                        <p><strong>Phone:</strong> ${request.phone}</p>
                        <p><strong>Requested:</strong> ${new Date(request.requestedAt).toLocaleString()}</p>
                    </div>
                    <div class="request-actions">
                        <button class="btn btn-approve" data-user-id="${request.userId}">
                            Approve
                        </button>
                        <button class="btn btn-reject" data-user-id="${request.userId}">
                            Reject
                        </button>
                    </div>
                </div>
            `
                    )
                    .join('');

                // Add event listeners to the buttons
                container.querySelectorAll('.btn-approve').forEach((button) => {
                    button.addEventListener('click', (e) => {
                        const userId = e.target.getAttribute('data-user-id');
                        approveRequest(userId);
                    });
                });

                container.querySelectorAll('.btn-reject').forEach((button) => {
                    button.addEventListener('click', (e) => {
                        const userId = e.target.getAttribute('data-user-id');
                        showRejectModal(userId);
                    });
                });
            }

            async function approveRequest(userId) {
                console.log('approveRequest called with userId:', userId);
                console.log('authToken:', authToken);

                if (
                    !confirm(
                        'Are you sure you want to approve this recovery key reset request?'
                    )
                ) {
                    return;
                }

                try {
                    console.log('Making API call to approve request...');
                    const response = await fetch(
                        `${window.location.origin}/api/auth/approve-recovery-key-reset/${userId}`,
                        {
                            method: 'POST',
                            headers: {
                                Authorization: `Bearer ${authToken}`,
                                'Content-Type': 'application/json',
                            },
                        }
                    );

                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);

                    if (!response.ok) {
                        throw new Error('Failed to approve request');
                    }

                    const data = await response.json();
                    console.log('Response data:', data);
                    showMessage('Request approved successfully!', 'success');
                    showTemporaryKey(data.temporaryKey);
                    loadRequests(); // Reload the list
                } catch (error) {
                    console.error('Error in approveRequest:', error);
                    showMessage(
                        'Error approving request: ' + error.message,
                        'error'
                    );
                }
            }

            function showRejectModal(userId) {
                currentUserId = userId;
                document.getElementById('rejectModal').style.display = 'block';
                document.getElementById('rejectReason').value = '';
            }

            function closeRejectModal() {
                document.getElementById('rejectModal').style.display = 'none';
                currentUserId = null;
            }

            async function confirmReject() {
                const reason = document
                    .getElementById('rejectReason')
                    .value.trim();

                if (!reason) {
                    alert('Please provide a reason for rejection');
                    return;
                }

                try {
                    const response = await fetch(
                        `${window.location.origin}/api/auth/reject-recovery-key-reset/${currentUserId}`,
                        {
                            method: 'POST',
                            headers: {
                                Authorization: `Bearer ${authToken}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ reason }),
                        }
                    );

                    if (!response.ok) {
                        throw new Error('Failed to reject request');
                    }

                    showMessage('Request rejected successfully', 'success');
                    closeRejectModal();
                    loadRequests(); // Reload the list
                } catch (error) {
                    showMessage(
                        'Error rejecting request: ' + error.message,
                        'error'
                    );
                }
            }

            function showMessage(message, type) {
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = `<div class="${type}">${message}</div>`;

                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 5000);
            }

            function showTemporaryKey(temporaryKey) {
                const tempKeyDisplay =
                    document.getElementById('tempKeyDisplay');
                tempKeyDisplay.innerHTML = `
                    <div class="temp-key-display">
                        <button class="close-temp-key" id="closeTempKeyBtn">&times;</button>
                        <h4>🔑 Temporary Recovery Key Generated</h4>
                        <p style="color: #6b7280; font-size: 14px; margin-bottom: 10px;">
                            Copy this key and share it with the user. They can use it to reset their recovery key.
                        </p>
                        <div class="temp-key-container">
                            <input type="text" class="temp-key-text" value="${temporaryKey}" readonly id="tempKeyInput">
                            <button class="copy-btn" id="copyBtn">Copy</button>
                        </div>
                    </div>
                `;
                tempKeyDisplay.style.display = 'block';

                // Add event listeners after the HTML is inserted
                document
                    .getElementById('closeTempKeyBtn')
                    .addEventListener('click', hideTemporaryKey);
                document
                    .getElementById('copyBtn')
                    .addEventListener('click', copyTemporaryKey);
            }

            function hideTemporaryKey() {
                const tempKeyDisplay =
                    document.getElementById('tempKeyDisplay');
                tempKeyDisplay.style.display = 'none';
                tempKeyDisplay.innerHTML = '';
            }

            function copyTemporaryKey() {
                const tempKeyInput = document.getElementById('tempKeyInput');
                const copyBtn = document.getElementById('copyBtn');

                // Select the text
                tempKeyInput.select();
                tempKeyInput.setSelectionRange(0, 99999); // For mobile devices

                // Copy to clipboard
                try {
                    document.execCommand('copy');
                    copyBtn.textContent = 'Copied!';
                    copyBtn.classList.add('copied');

                    // Reset button after 2 seconds
                    setTimeout(() => {
                        copyBtn.textContent = 'Copy';
                        copyBtn.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    // Fallback for modern browsers
                    navigator.clipboard
                        .writeText(tempKeyInput.value)
                        .then(() => {
                            copyBtn.textContent = 'Copied!';
                            copyBtn.classList.add('copied');

                            setTimeout(() => {
                                copyBtn.textContent = 'Copy';
                                copyBtn.classList.remove('copied');
                            }, 2000);
                        })
                        .catch(() => {
                            alert(
                                'Failed to copy. Please select and copy manually.'
                            );
                        });
                }
            }

            // Close modal when clicking outside
            window.onclick = function (event) {
                const modal = document.getElementById('rejectModal');
                if (event.target === modal) {
                    closeRejectModal();
                }
            };

            // Notification functions
            async function loadNotifications() {
                try {
                    const response = await fetch(
                        `${window.location.origin}/api/notifications/admin`,
                        {
                            method: 'GET',
                            headers: {
                                Authorization: `Bearer ${authToken}`,
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                        }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            displayNotifications(data.data.notifications);
                        }
                    } else {
                        console.error(
                            'Failed to load notifications:',
                            response.status
                        );
                    }
                } catch (error) {
                    console.error('Error loading notifications:', error);
                }
            }

            function displayNotifications(notifications) {
                const notificationList =
                    document.getElementById('notificationList');
                const notificationBadge =
                    document.getElementById('notificationBadge');

                // Filter for recovery key reset requests
                const recoveryKeyNotifications = notifications.filter(
                    (notification) =>
                        notification.category === 'system' &&
                        notification.data &&
                        notification.data.actionType ===
                            'recovery_key_reset_request'
                );

                // Update badge count
                notificationBadge.textContent = recoveryKeyNotifications.length;

                if (recoveryKeyNotifications.length === 0) {
                    notificationList.innerHTML =
                        '<div class="no-notifications"><p>No recent requests</p></div>';
                    return;
                }

                // Sort by creation date (newest first)
                recoveryKeyNotifications.sort(
                    (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
                );

                // Display notifications
                notificationList.innerHTML = recoveryKeyNotifications
                    .map((notification) => {
                        const timeAgo = getTimeAgo(
                            new Date(notification.createdAt)
                        );
                        const isRead = notification.read ? 'read' : 'unread';

                        return `
                        <div class="notification-item ${isRead}">
                            <div class="notification-content">
                                <div class="notification-title">${notification.title}</div>
                                <div class="notification-message">${notification.message}</div>
                                <div class="notification-time">${timeAgo}</div>
                            </div>
                            <div class="notification-actions">
                                <button class="notification-btn primary" onclick="viewRequest('${notification.data.userId}')">
                                    View Request
                                </button>
                                <button class="notification-btn secondary" onclick="markNotificationRead('${notification._id}')">
                                    Mark Read
                                </button>
                            </div>
                        </div>
                    `;
                    })
                    .join('');
            }

            function getTimeAgo(date) {
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);

                if (diffInSeconds < 60) return 'Just now';
                if (diffInSeconds < 3600)
                    return `${Math.floor(diffInSeconds / 60)}m ago`;
                if (diffInSeconds < 86400)
                    return `${Math.floor(diffInSeconds / 3600)}h ago`;
                return `${Math.floor(diffInSeconds / 86400)}d ago`;
            }

            function viewRequest(userId) {
                // Scroll to the request in the main list
                const requestElement = document.querySelector(
                    `[data-user-id="${userId}"]`
                );
                if (requestElement) {
                    requestElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center',
                    });
                    requestElement.style.backgroundColor = '#fef3c7';
                    setTimeout(() => {
                        requestElement.style.backgroundColor = '';
                    }, 3000);
                }
            }

            async function markNotificationRead(notificationId) {
                try {
                    const response = await fetch(
                        `${window.location.origin}/api/notifications/admin/${notificationId}/read`,
                        {
                            method: 'PATCH',
                            headers: {
                                Authorization: `Bearer ${authToken}`,
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                        }
                    );

                    if (response.ok) {
                        // Reload notifications to update the display
                        loadNotifications();
                    }
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            }

            // Auto-refresh notifications every 30 seconds
            setInterval(() => {
                if (authToken) {
                    loadNotifications();
                }
            }, 30000);
        </script>
    </body>
</html>
